<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestLedger Charts</title>
    <!-- 加载Plotly.js库 (从CDN) -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .chart-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 15px;
            padding: 15px;
        }
        h2 {
            margin-top: 0;
            color: #333;
            font-size: 18px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        #profit-loss-chart, #asset-distribution-chart {
            width: 100%;
            height: 300px;
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <h2>盈亏趋势</h2>
        <div id="profit-loss-chart"></div>
    </div>
    
    <div class="chart-container">
        <h2>资产分布</h2>
        <div id="asset-distribution-chart"></div>
    </div>
    
    <script>
        // 初始化空图表
        document.addEventListener('DOMContentLoaded', function() {
            // 创建空的盈亏趋势图
            var profitLossLayout = {
                title: '',
                barmode: 'group',
                yaxis: {title: '金额'},
                legend: {orientation: 'h', y: -0.2},
                margin: {l: 50, r: 50, t: 30, b: 80},
                plot_bgcolor: '#fff',
                paper_bgcolor: '#fff'
            };
            
            Plotly.newPlot('profit-loss-chart', [], profitLossLayout);
            
            // 创建空的资产分布图
            var distributionLayout = {
                title: '',
                margin: {l: 20, r: 20, t: 30, b: 20},
                legend: {orientation: 'v'},
                plot_bgcolor: '#fff',
                paper_bgcolor: '#fff'
            };
            
            Plotly.newPlot('asset-distribution-chart', [], distributionLayout);
            
            // 通知QML页面已加载完成
            if (typeof qt !== 'undefined') {
                // 如果在Qt WebView环境中运行，发送消息
                qt.WebChannel.objects.chartView.pageLoaded();
            } else {
                console.log("页面在非Qt环境中加载");
            }
        });
        
        // 更新图表函数，由QML调用
        function updateCharts(data) {
            console.log("接收到更新图表数据");
            
            try {
                // 更新盈亏趋势图
                updateProfitLossChart(data.profitLoss);
                
                // 更新资产分布图
                updateAssetDistributionChart(data.assetDistribution);
                
                return true;
            } catch (e) {
                console.error("更新图表时出错:", e);
                return false;
            }
        }
        
        // 更新盈亏趋势图
        function updateProfitLossChart(data) {
            // 盈利柱状图
            var profitTrace = {
                x: data.months,
                y: data.profits,
                name: '盈利',
                type: 'bar',
                marker: {
                    color: '#2ecc71'
                }
            };
            
            // 亏损柱状图
            var lossTrace = {
                x: data.months,
                y: data.losses,
                name: '亏损',
                type: 'bar',
                marker: {
                    color: '#e74c3c'
                }
            };
            
            // 净值折线图
            var netTrace = {
                x: data.months,
                y: data.netValues,
                name: '净值',
                type: 'scatter',
                mode: 'lines+markers',
                line: {
                    color: '#3498db',
                    width: 3
                },
                marker: {
                    size: 8
                }
            };
            
            var layout = {
                title: '',
                barmode: 'group',
                yaxis: {title: '金额'},
                legend: {orientation: 'h', y: -0.2},
                margin: {l: 50, r: 50, t: 30, b: 80},
                plot_bgcolor: '#fff',
                paper_bgcolor: '#fff'
            };
            
            Plotly.react('profit-loss-chart', [profitTrace, lossTrace, netTrace], layout);
        }
        
        // 更新资产分布图
        function updateAssetDistributionChart(data) {
            // 设置饼图数据
            var trace = {
                labels: data.types,
                values: data.percentages,
                type: 'pie',
                hole: 0.4,
                textinfo: 'label+percent',
                textposition: 'outside',
                automargin: true,
                marker: {
                    colors: ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6']
                }
            };
            
            var layout = {
                title: '',
                showlegend: true,
                legend: {orientation: 'v'},
                margin: {l: 20, r: 20, t: 30, b: 20},
                plot_bgcolor: '#fff',
                paper_bgcolor: '#fff'
            };
            
            Plotly.react('asset-distribution-chart', [trace], layout);
        }
        
        // 用于测试的函数
        function testCharts() {
            // 测试盈亏数据
            var testProfitLoss = {
                months: ["1月", "2月", "3月", "4月", "5月", "6月"],
                profits: [500, 700, 600, 800, 900, 1000],
                losses: [200, 300, 250, 400, 350, 300],
                netValues: [300, 400, 350, 400, 550, 700]
            };
            
            // 测试资产分布数据
            var testDistribution = {
                types: ["股票", "基金", "债券", "外汇", "其他"],
                percentages: [30, 25, 20, 15, 10]
            };
            
            // 测试更新图表
            updateCharts({
                profitLoss: testProfitLoss,
                assetDistribution: testDistribution
            });
        }
        
        // 如果在浏览器环境中，自动运行测试数据
        if (typeof qt === 'undefined') {
            // 延迟1秒后加载测试数据
            setTimeout(testCharts, 1000);
        }
    </script>
</body>
</html> 