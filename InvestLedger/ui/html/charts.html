<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestLedger Charts</title>
    <!-- 加载Plotly.js库 (从CDN) -->
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <!-- 加载Qt WebChannel的脚本 -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            overflow-y: hidden; /* 禁止body的垂直滚动条 */
        }
        .chart-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 15px;
            padding: 15px;
        }
        h2 {
            margin-top: 0;
            color: #333;
            font-size: 18px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .chart {
            width: 100%;
            height: 280px;
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <h2>盈亏趋势</h2>
        <div id="profit-loss-chart" class="chart"></div>
    </div>
    
    <div class="chart-container">
        <h2>个股盈亏排名</h2>
        <div id="stock-ranking-chart" class="chart"></div>
    </div>
    
    <div class="chart-container">
        <h2>月度交易量分析</h2>
        <div id="monthly-volume-chart" class="chart"></div>
    </div>
    
    <div class="chart-container">
        <h2>盈亏比率趋势</h2>
        <div id="win-loss-ratio-chart" class="chart"></div>
    </div>
    
    <script>
        // 全局变量以保存chartView对象引用
        var chartView = null;

        // Function to report content height to QML
        function reportContentHeight() {
            if (chartView && typeof chartView.setHtmlContentHeight === 'function') {
                var height = document.body.scrollHeight;
                console.log("JS: Reporting HTML content height to QML:", height);
                chartView.setHtmlContentHeight(height);
            } else {
                // console.log("JS: chartView or setHtmlContentHeight not ready for reporting height.");
            }
        }

        // 初始化WebChannel
        function initWebChannel() {
            if (typeof QWebChannel !== 'undefined') {
                new QWebChannel(qt.webChannelTransport, function(channel) {
                    chartView = channel.objects.chartView; // Assign to global
                    console.log("WebChannel初始化成功", chartView ? "chartView已获取" : "chartView未获取");
                    
                    if (chartView && typeof chartView.pageLoaded === 'function') {
                        chartView.pageLoaded();
                    }
                    // Initial height report
                    reportContentHeight();
                });
            } else {
                console.error("QWebChannel未定义，可能未正确加载qwebchannel.js");
            }
        }

        // 初始化空图表
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化所有图表为空
            initEmptyCharts();
            
            // 检查URL参数中是否包含数据
            checkUrlForData(); // This might call updateCharts
            
            // 初始化WebChannel
            initWebChannel(); // Sets up chartView and does an initial reportContentHeight

            // Setup ResizeObserver
            if (typeof ResizeObserver !== 'undefined') {
                const ro = new ResizeObserver(entries => {
                    reportContentHeight(); 
                });
                ro.observe(document.body);
                console.log("JS: ResizeObserver attached to document.body");
            } else {
                // Fallback: report on window resize if ResizeObserver is not available
                window.addEventListener('resize', reportContentHeight);
                console.log("JS: ResizeObserver not available, using window.resize fallback for height reporting.");
            }
        });
        
        // 初始化所有空图表
        function initEmptyCharts() {
            // 盈亏趋势图
            var profitLossLayout = {
                title: '',
                barmode: 'group',
                yaxis: {title: '金额'},
                legend: {orientation: 'h', y: -0.2},
                margin: {l: 50, r: 50, t: 30, b: 80},
                plot_bgcolor: '#fff',
                paper_bgcolor: '#fff'
            };
            Plotly.newPlot('profit-loss-chart', [], profitLossLayout);
            
            // 个股盈亏排名图
            var stockRankingLayout = {
                title: '',
                yaxis: {title: '盈亏金额'},
                margin: {l: 60, r: 30, t: 30, b: 80},
                plot_bgcolor: '#fff',
                paper_bgcolor: '#fff'
            };
            Plotly.newPlot('stock-ranking-chart', [], stockRankingLayout);
            
            // 月度交易量图
            var volumeLayout = {
                title: '',
                yaxis: {title: '交易量'},
                xaxis: {title: '月份'},
                margin: {l: 50, r: 30, t: 30, b: 50},
                plot_bgcolor: '#fff',
                paper_bgcolor: '#fff'
            };
            Plotly.newPlot('monthly-volume-chart', [], volumeLayout);
            
            // 盈亏比率趋势图
            var ratioLayout = {
                title: '',
                yaxis: {title: '比率 (%)'},
                xaxis: {title: '月份'},
                margin: {l: 50, r: 30, t: 30, b: 50},
                plot_bgcolor: '#fff',
                paper_bgcolor: '#fff'
            };
            Plotly.newPlot('win-loss-ratio-chart', [], ratioLayout);
        }
        
        // 检查URL参数中是否包含图表数据
        function checkUrlForData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');
                
                if (dataParam) {
                    console.log("从URL参数中检测到数据");
                    const data = JSON.parse(decodeURIComponent(dataParam));
                    updateCharts(data); // This will now be async and report height
                }
            } catch (e) {
                console.error("解析URL数据参数失败:", e);
            }
        }
        
        // 更新图表函数，由QML调用
        async function updateCharts(data) { // Make async
            console.log("接收到更新图表数据", data);
            
            try {
                // 确保我们有有效的数据对象
                if (!data) {
                    console.error("接收到的数据格式无效:", data);
                    reportContentHeight(); // Report height even if data is invalid (e.g. for empty state)
                    // 通知 QML (可选，如果需要处理这种情况)
                    if (chartView && typeof chartView.chartsRendered === 'function') {
                        chartView.chartsRendered(); // 即使没有数据，也要通知QML渲染流程完成
                    }
                    return false;
                }
                
                const promises = [];
                // 更新盈亏趋势图
                if (data.profitLoss) {
                    console.log("JS: 更新盈亏趋势图，数据月份:", data.profitLoss.months ? data.profitLoss.months.length : 0, "项");
                    promises.push(updateProfitLossChart(data.profitLoss));
                }
                
                // 更新个股盈亏排名图
                if (data.stockRanking) {
                    console.log("JS: 更新个股盈亏排名图，数据:", data.stockRanking.stocks ? data.stockRanking.stocks.length : 0, "项");
                    promises.push(updateStockRankingChart(data.stockRanking));
                }
                
                // 更新月度交易量图
                if (data.monthlyVolume) {
                    console.log("JS: 更新月度交易量图，数据月份:", data.monthlyVolume.months ? data.monthlyVolume.months.length : 0, "项");
                    promises.push(updateMonthlyVolumeChart(data.monthlyVolume));
                }
                
                // 更新盈亏比率趋势图
                if (data.winLossRatio) {
                    console.log("JS: 更新盈亏比率趋势图，数据月份:", data.winLossRatio.months ? data.winLossRatio.months.length : 0, "项");
                    promises.push(updateWinLossRatioChart(data.winLossRatio));
                }

                if (promises.length > 0) {
                    console.log("JS: 等待所有图表更新完成...");
                    await Promise.all(promises);
                    console.log("JS: All charts updated via Plotly.react promises.");
                } else {
                    console.log("JS: No chart data provided to update.");
                }
                
                // 报告内容高度
                reportContentHeight(); // 确保在调用QML前高度已报告
                console.log("JS: 内容高度已报告，现在通知QML图表渲染完成");

                // 确认在DOM中有图表元素
                const chartElements = document.querySelectorAll('.chart');
                console.log("JS: 页面中有", chartElements.length, "个图表元素");
                
                // 通知 QML 图表已渲染完成
                if (chartView && typeof chartView.chartsRendered === 'function') {
                    chartView.chartsRendered();
                    console.log("JS: Called QML chartView.chartsRendered()");
                } else {
                    console.error("JS: QML object 'chartView' not found or chartsRendered is not a function. Cannot notify QML completion.");
                }

                return true;
            } catch (e) {
                console.error("更新图表时出错:", e);
                reportContentHeight(); // 即使出错，也尝试报告高度
                
                // 通知 QML 出错
                if (chartView && typeof chartView.chartsRendered === 'function') {
                    // 即使有错误，也调用chartsRendered以解除加载状态
                    chartView.chartsRendered();
                    console.log("JS: Called QML chartsRendered() despite error to unblock UI");
                }
                return false;
            }
        }
        
        // 更新盈亏趋势图
        function updateProfitLossChart(data) {
            try {
                console.log("JS updateProfitLossChart: 接收数据:", JSON.stringify(data));
                
                // 检查数据有效性
                if (!data || !data.months || data.months.length === 0) {
                    console.error("JS updateProfitLossChart: 无效的数据格式");
                    return Plotly.react('profit-loss-chart', [], {});
                }
                
                // 盈利柱状图
                var profitTrace = {
                    x: data.months,
                    y: data.profits,
                    name: '盈利',
                    type: 'bar',
                    marker: {
                        color: '#2ecc71'
                    }
                };
                
                // 亏损柱状图
                var lossTrace = {
                    x: data.months,
                    y: data.losses,
                    name: '亏损',
                    type: 'bar',
                    marker: {
                        color: '#e74c3c'
                    }
                };
                
                // 净值折线图
                var netTrace = {
                    x: data.months,
                    y: data.netValues,
                    name: '净值',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: {
                        color: '#3498db',
                        width: 3
                    },
                    marker: {
                        size: 8
                    }
                };
                
                var layout = {
                    title: '',
                    barmode: 'group',
                    yaxis: {title: '金额'},
                    legend: {orientation: 'h', y: -0.2},
                    margin: {l: 50, r: 50, t: 30, b: 80},
                    plot_bgcolor: '#fff',
                    paper_bgcolor: '#fff'
                };
                
                var traces = [profitTrace, lossTrace, netTrace];
                console.log("JS updateProfitLossChart: Plotly.react准备绘制图表，数据点数:", traces[0].x.length);
                return Plotly.react('profit-loss-chart', traces, layout); // Return promise
            } catch (e) {
                console.error("JS updateProfitLossChart 错误:", e);
                return Promise.resolve(); // 返回一个已解决的Promise，以避免中断其他图表的更新
            }
        }
        
        // 更新个股盈亏排名图
        function updateStockRankingChart(data) {
            try {
                console.log("JS updateStockRankingChart: 接收数据:", JSON.stringify(data));
                
                // 检查数据有效性
                if (!data || !data.stocks || data.stocks.length === 0) {
                    console.error("JS updateStockRankingChart: 无效的数据格式");
                    return Plotly.react('stock-ranking-chart', [], {});
                }
                
                var colors = data.values.map(function(value) {
                    return value >= 0 ? '#2ecc71' : '#e74c3c';
                });
                
                var trace = {
                    x: data.stocks,
                    y: data.values,
                    type: 'bar',
                    marker: {
                        color: colors
                    }
                };
                
                var layout = {
                    title: '',
                    yaxis: {title: '盈亏金额'},
                    margin: {l: 60, r: 30, t: 30, b: 100},
                    plot_bgcolor: '#fff',
                    paper_bgcolor: '#fff',
                    xaxis: {
                        tickangle: -45
                    }
                };
                
                console.log("JS updateStockRankingChart: Plotly.react准备绘制图表，数据点数:", trace.x.length);
                return Plotly.react('stock-ranking-chart', [trace], layout); // Return promise
            } catch (e) {
                console.error("JS updateStockRankingChart 错误:", e);
                return Promise.resolve(); // 返回一个已解决的Promise，以避免中断其他图表的更新
            }
        }
        
        // 更新月度交易量图
        function updateMonthlyVolumeChart(data) {
            try {
                console.log("JS updateMonthlyVolumeChart: 接收数据:", JSON.stringify(data));
                
                // 检查数据有效性
                if (!data || !data.months || data.months.length === 0) {
                    console.error("JS updateMonthlyVolumeChart: 无效的数据格式");
                    return Plotly.react('monthly-volume-chart', [], {});
                }
                
                var trace = {
                    x: data.months,
                    y: data.volumes,
                    type: 'bar',
                    marker: {
                        color: '#3498db'
                    }
                };
                
                var layout = {
                    title: '',
                    yaxis: {title: '交易量'},
                    xaxis: {title: '月份'},
                    margin: {l: 50, r: 30, t: 30, b: 50},
                    plot_bgcolor: '#fff',
                    paper_bgcolor: '#fff'
                };
                
                console.log("JS updateMonthlyVolumeChart: Plotly.react准备绘制图表，数据点数:", trace.x.length);
                return Plotly.react('monthly-volume-chart', [trace], layout); // Return promise
            } catch (e) {
                console.error("JS updateMonthlyVolumeChart 错误:", e);
                return Promise.resolve(); // 返回一个已解决的Promise，以避免中断其他图表的更新
            }
        }
        
        // 更新盈亏比率趋势图
        function updateWinLossRatioChart(data) {
            try {
                console.log("JS updateWinLossRatioChart: 接收数据:", JSON.stringify(data));
                
                // 检查数据有效性
                if (!data || !data.months || data.months.length === 0) {
                    console.error("JS updateWinLossRatioChart: 无效的数据格式");
                    return Plotly.react('win-loss-ratio-chart', [], {});
                }
                
                var winRateTrace = {
                    x: data.months,
                    y: data.winRates,
                    name: '胜率',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: {
                        color: '#2ecc71',
                        width: 3
                    },
                    marker: {
                        size: 8
                    }
                };
                
                var profitLossRatioTrace = {
                    x: data.months,
                    y: data.profitLossRatios,
                    name: '盈亏比',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: {
                        color: '#3498db',
                        width: 3
                    },
                    marker: {
                        size: 8
                    },
                    yaxis: 'y2'
                };
                
                var layout = {
                    title: '',
                    yaxis: {
                        title: '胜率 (%)',
                        rangemode: 'tozero'
                    },
                    yaxis2: {
                        title: '盈亏比',
                        overlaying: 'y',
                        side: 'right',
                        rangemode: 'tozero'
                    },
                    xaxis: {title: '月份'},
                    legend: {orientation: 'h', y: -0.2},
                    margin: {l: 50, r: 50, t: 30, b: 80},
                    plot_bgcolor: '#fff',
                    paper_bgcolor: '#fff'
                };
                
                var traces = [winRateTrace, profitLossRatioTrace];
                console.log("JS updateWinLossRatioChart: Plotly.react准备绘制图表，数据点数:", traces[0].x.length);
                return Plotly.react('win-loss-ratio-chart', traces, layout); // Return promise
            } catch (e) {
                console.error("JS updateWinLossRatioChart 错误:", e);
                return Promise.resolve(); // 返回一个已解决的Promise，以避免中断其他图表的更新
            }
        }
        
        // 用于测试的函数
        function testCharts() {
            // 测试数据
            var testData = {
                profitLoss: {
                months: ["1月", "2月", "3月", "4月", "5月", "6月"],
                profits: [500, 700, 600, 800, 900, 1000],
                losses: [200, 300, 250, 400, 350, 300],
                netValues: [300, 400, 350, 400, 550, 700]
                },
                stockRanking: {
                    stocks: ["阿里巴巴", "腾讯控股", "贵州茅台", "中国平安", "招商银行", "格力电器", "美的集团", "万科A"],
                    values: [1200, 900, 800, 500, -300, -400, -600, -700]
                },
                monthlyVolume: {
                    months: ["1月", "2月", "3月", "4月", "5月", "6月"],
                    volumes: [15, 22, 18, 25, 30, 28]
                },
                winLossRatio: {
                    months: ["1月", "2月", "3月", "4月", "5月", "6月"],
                    winRates: [60, 65, 62, 70, 72, 75],
                    profitLossRatios: [1.5, 1.8, 1.6, 2.0, 2.2, 2.3]
                }
            };
            
            // 测试更新图表
            updateCharts(testData);
        }
        
        // 如果在浏览器环境中，自动运行测试数据
        if (typeof qt === 'undefined') {
            // 延迟1秒后加载测试数据
            setTimeout(testCharts, 1000);
        }
    </script>
</body>
</html> 