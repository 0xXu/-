## 一、项目概述

1. **项目名称**：轻量个人投资记账程序（InvestLedger）
2. **目标平台**：Windows 10 及以上
3. **开发语言**：Python 3.9+
4. **UI 框架**：PySide6 + QtQuick/QML
5. **版本管理与发布**：Git + GitHub Release
6. **网络依赖**：仅用于检测和下载更新，其他功能完全本地运行

## 二、功能需求

### 1. 界面与动画效果

* 使用 QtQuick/QML 实现：

  * 页面切换平滑过渡动画
  * 数据加载时的进度指示动画
  * 按钮点击、悬停反馈动画
* 支持亮/暗主题及用户自定义配色方案
* 主界面组件：资产概览、交易列表、统计图表、快速操作栏

### 2. 启动更新检测

* 启动时调用 GitHub Release API：

  1. 比较本地 `__version__` 与最新版本
  2. 弹窗提示“立即更新/下次启动自动更新”
  3. 下载 .zip → 解压 → 替换程序文件 → 保留配置与数据 → 提示重启
* 网络异常自动跳过，保证离线可用

### 3. 数据导入与解析

* **文件导入**：CSV/TSV，自定义分隔符；字段：日期、资产类别、项目名称、数量、单价、币种、备注
* **粘贴导入**：弹窗粘贴多行文本，实时预览解析结果
* **自定义文本格式解析**：支持以下格式的批量粘贴：

  ```
  若羽臣：盈310元， 2025年4月10日
  正海磁材：亏212元， 2025年4月14日
  ```

  * 解析规则：

    1. `项目名称` 位于冒号前；
    2. `盈/亏` 表示净收益或亏损，提取整数金额并自动转换为正/负数；
    3. `元` 视为基准货币，可扩展至多币种标记；
    4. 逗号后为 `日期`，解析为标准 `YYYY-MM-DD`；
  * 粘贴后自动批量转换为交易记录，解析错误行高亮并可手动修正
* 导入前校验字段完整性与格式，错误高亮，支持跳过或手动修正

### 4. 直接在程序内记录

* **手动录入交易**：

  * 在主界面或交易列表界面提供“新增交易”按钮，弹出填写表单
  * 表单字段：日期、项目名称、盈亏金额（正数/负数）、币种、类别、备注
  * 支持使用快捷键打开录入对话框，提高录入效率
* **快速录入模式**：

  * 输入框可按 `项目名称:盈亏金额, YYYY-MM-DD` 单行快速输入并回车保存
  * 支持撤销/重做和自动保存草稿

### 5. 多用户管理

* 启动界面列出已创建用户名，无需密码，单击即可切换或新建
* 用户数据隔离存储，切换时自动加载对应数据库

### 6. 核心功能增强

* **搜索与过滤**：支持按日期范围、资产类别、标签、文本关键字等多条件组合查询
* **标签管理**：可自定义标签并批量编辑交易，支持多级分类
* **批量操作**：多选交易记录，实现批量删除、编辑或导出
* **撤销/重做**：支持对数据操作的多级撤销与重做
* **快捷键支持**：常用操作提供可自定义快捷键，提高效率
* **数据导入预设**：保存常用导入模板，减少重复设置工作

### 7. 拓展功能

* **统计图表**：折线图、柱状图、饼图，支持按时间、类别筛选
* **导出报告**：一键生成 PDF/Excel 报表，定期生成投资报告
* **预算告警**：为资产或类别设置预算阈值，超出时通过系统通知提醒
* **多币种汇率**：集成免费汇率 API，离线缓存汇率数据
* **自动备份**：程序退出时按日生成 .bak 备份文件，保留最近7天

### 8. 盈利目标管理

* **目标设置**：在设置页面添加“盈利目标”模块，包括：

  * 月度目标：输入当月预期净收益金额
  * 年度目标：输入当年预期净收益金额
* **实时对比**：系统自动计算并展示：

  * 当月实际净收益 vs 月度目标
  * 本年累计净收益 vs 年度目标
* **告警提醒**：当实际收益达成一定百分比（例如 80%）时，通过系统通知或界面高亮提醒



## 三、数据存储与路径、数据存储与路径

* **存储方案**：SQLite 单文件数据库
* **数据库路径**：
  `%APPDATA%\InvestLedger\{username}\data.db`
* **配置文件**：JSON 格式，保存在同级目录，用于界面设置、主题、上次查看位置等
* **备份机制**：正常退出时复制当天数据库为 `data_YYYYMMDD.bak`，最多保留 7 个备份

## 四、系统架构

```plaintext
InvestLedger/
├─ main.py          # 启动：更新检测 → 用户选择 → 加载 UI
├─ updater.py       # GitHub Release 接口、下载与替换逻辑
├─ user.py          # 用户列表管理、创建/删除/切换
├─ storage.py       # SQLite 连接、ORM 模型、CRUD 接口
├─ importer.py      # 文本解析、校验与批量导入
├─ analyzer.py      # 数据统计与图表数据生成
└─ ui/
   ├─ main.qml      # 主界面布局与动画
   ├─ dialogs.qml   # 导入/导出/设置弹窗
   ├─ components/   # 自定义控件：图表视图、动画元素
   └─ backend.py    # QML 与 Python 接口桥梁
```

## 五、技术选型与依赖

* **Python 3.9+**
* **PySide6**：进行 QtQuick/QML 界面与动画开发
* **requests**：GitHub API 调用
* **SQLite3**（Python 标准库）：本地数据存储
* **QtCharts (Qt Quick ChartView)**原生 QML ChartView 及系列组件（LineSeries、BarSeries、PieSeries 等）多种内置主题：Brown Sand、Blue Cerulean、Dark、Light 等，可在运行时切换支持动画与交互：序列逐点动画加载、鼠标悬停提示、图例开关与 QML 数据模型无缝绑定，减少中间渲染流程开销 导出能力：借助 QChart::grabToImage() 或 QQuickItem::grabToImage() 导出高分辨率 PNG
* **PyInstaller**：生成 Windows 可执行安装包


## 七、后续扩展与优化

* **错误处理与提示**：全局异常捕获，友好提示用户并在日志中记录堆栈信息


## 九、用户文档与帮助

* **内置帮助面板**：QML 弹窗展示功能指南、快捷键列表与常见问题
* **Markdown 手册**：项目源码中包含 `docs/` 目录，提供详细用户手册与开发文档
* **版本日志**：更新模块中可查看历史 Release Notes

## 十、测试策略

* **单元测试**：覆盖核心模块（`storage.py`,`importer.py`,`analyzer.py`）
* **UI 测试**：使用 `pytest-qt` 对关键界面交互进行自动化测试
* **性能测试**：对大规模导入（10W 行）进行基准测试，保证解析在 5 秒内完成

---

## 十一、界面详细设计

### 1. 启动与用户选择界面

* **布局**：居中浮层风格，应用程序 Logo 与版本号置顶，用户名列表以下拉形式展示
* **交互**：

  * 点击用户卡片进入主界面
  * “新建用户”按钮触发文本输入弹窗，用于输入新用户名
* **动画**：下拉菜单弹出与收回具有淡入淡出和滑动过渡

### 2. 主仪表盘（Dashboard）

* **顶部导航栏**：

  * Logo + 应用名称
  * 切换主题按钮（亮/暗）
  * 更新检查按钮
  * 设置与帮助菜单
* **左侧侧边栏**：图标与文字并列，模块快捷入口：

  * 资产概览
  * 交易列表
  * 统计图表
  * 导入导出
* **主视图区域**：

  * **资产概览面板**：卡片式展示总资产、各类别占比（饼图）、最新行情摘要；其中盈亏数据全局红绿配色：盈利红色、亏损绿色
  * **快速操作栏**：添加交易、批量导入、生成报表按钮等
* **底部状态栏**：显示当前用户名、数据库状态（在线/离线）、备份日期等
* **动画**：

  * 面板切换时的滑动与淡入动画
  * 按钮点击缩放反馈

### 3. 交易列表界面. 交易列表界面

* **表格视图**：支持排序、过滤、批量选择
* **数值颜色编码**：

  * 盈利金额显示为红色字体，亏损金额显示为绿色字体，配色与股票行情一致
* **右键菜单**：对单条记录提供编辑、删除、复制操作
* **批量操作栏**：在选中多条记录时显示批量删除、导出等按钮
* **分页与虚拟滚动**：当记录数超过 1k，启用虚拟列表提升性能
* **动画**：行 hover 时背景渐变，删除时淡出动画

### 4. 导入导出弹窗. 导入导出弹窗

* **步骤导航**：顶部显示导入流程（选择文件 → 字段映射 → 校验 → 完成）
* **字段映射表**：左侧为文件字段，右侧为系统字段，下拉选择对应关系
* **校验结果区域**：高亮显示错误行，提供跳过和编辑选项
* **完成页**：导入统计信息及快捷跳转按钮（打开交易列表/导出报表）

### 5. 统计图表界面

* **图表区域**：可切换折线图、柱状图、饼图，支持图例开关与交互式数据提示；所有涉及盈亏的图表元素（点/柱/扇区）均采用红色表示盈利、绿色表示亏损
* **筛选面板**：日期范围选择、类别多选、标签搜索
* **导出功能**：图表导出为 PNG 或复制到剪贴板

### 6. 设置与帮助. 设置与帮助

* **设置页面**：

  * 主题与配色
  * 盈亏配色配置：支持用户自定义盈利、亏损的颜色值，并可恢复默认
  * 备份策略设置（备份天数）
**帮助面板**\*\*：包含功能介绍、快捷键列表、常见问题及反馈入口

以上界面详细设计结合 QML 动画与 Python 后端逻辑，确保交互流畅且视觉统一。
